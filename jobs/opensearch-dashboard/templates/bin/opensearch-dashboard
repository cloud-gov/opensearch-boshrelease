#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the webapp_ctl script
#source /var/vcap/jobs/opensearch-dashboard/helpers/ctl_setup.sh 'opensearch-dashboard'
export JOB_NAME=opensearch-dashboard
export JOB_DIR=/var/vcap/jobs/$JOB_NAME
<%
  opensearchsearch_port = nil
  if_link("opensearchsearch") { |opensearchsearch_link| opensearchsearch_port = opensearchsearch_link.p("opensearchsearch.port") }
  unless opensearchsearch_port
    opensearchsearch_port = p("opensearch-dashboard.opensearchsearch.port")
  end
%>

MEMORY_LIMIT=$(($(grep MemTotal /proc/meminfo | awk '{print $2}') * <%= p('opensearch-dashboard.memory_limit') %>/100 / 1024))
export NODE_OPTIONS="--max-old-space-size=$MEMORY_LIMIT"

<% p("opensearch-dashboard.env").each do |env| %>
export <%= env.keys[0] %>="<%= env.values[0] %>"
<% end %>

<% p("opensearch-dashboard.source_files").each do |sf| %>
source <%= sf %>
<% end %>

<% p("opensearch-dashboard.plugins").each do |plugin| name, path = plugin.first %>
    cd /var/vcap/packages/opensearch-dashboard/plugins/
  <% if path.start_with? '/var/vcap' %>
    /var/vcap/packages/opensearch-dashboard/bin/opensearch-dashboard-plugin install "file://<%= path %>"
  <% else %>
    /var/vcap/packages/opensearch-dashboard/bin/opensearch-dashboard-plugin install "<%= path %>"
  <% end %>
<% end %>

/var/vcap/packages/opensearch-dashboard/bin/opensearch-dashboard -c $JOB_DIR/config/opensearch-dashboard.conf
