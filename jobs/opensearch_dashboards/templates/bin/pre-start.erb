#!/bin/bash

export JOB_NAME=opensearch_dashboards
export JOB_DIR=/var/vcap/jobs/$JOB_NAME

if ! [[ $(ls -1 /var/vcap/packages/opensearch_dashboards/plugins | wc -l) == 0 ]]; then
  rm -rf /var/vcap/packages/opensearch_dashboards/plugins/*
fi

cd /var/vcap/packages/opensearch_dashboards
chown -R vcap:vcap config data plugins

<% if_link("opensearch") do |opensearch_config| %>
<% opensearch_config.if_p('opensearch.node.ssl.private_key') do %>
  openssl pkcs8 -v1 "PBE-SHA1-3DES" \
  -in "${JOB_DIR}/config/ssl/opensearch-node.pem" -topk8 \
  -out "${JOB_DIR}/config/ssl/opensearch-node.key" -nocrypt
  chmod 600 ${JOB_DIR}/config/ssl/opensearch*.key
<% end %>
<% end %>

if [ -d ${JOB_DIR}/config/ssl ]; then
	chown vcap:vcap ${JOB_DIR}/config/ssl
fi
