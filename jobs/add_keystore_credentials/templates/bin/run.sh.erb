#!/usr/bin/env bash

set -eu

export JQ_PACKAGE_DIR=/var/vcap/packages/jq
export PATH=$JQ_PACKAGE_DIR/bin:$PATH
export JOB_NAME=opensearch
export JOB_DIR=/var/vcap/jobs/$JOB_NAME
export STORE_DIR=/var/vcap/store/$JOB_NAME
export OPENSEARCH_PATH_CONF=${JOB_DIR}/config

<% if_p('opensearch.notifications.credential_map') do |credential_map| %>

  export CREDENTIAL_MAP="<%= p('opensearch.notifications.credential_map') %>"
  for SENDER_NAME in $(echo "$CREDENTIAL_MAP" | jq -r '. | keys | join("\n")'); do
    echo "adding credentials for $SENDER_NAME"

    SENDER_DATA=$(echo "$CREDENTIAL_MAP" | jq --arg sender "$SENDER_NAME" '.[$sender]')
    USERNAME=$(echo "$SENDER_DATA" | jq '.username')
    PASSWORD=$(echo "$SENDER_DATA" | jq '.password')

    if ! "$PACKAGE_DIR/bin/opensearch-keystore" get "opensearch.notifications.core.email.$SENDER_NAME.username"; then
      echo "adding username for $SENDER_NAME to keystore"
      echo "$USERNAME" | "$PACKAGE_DIR/bin/opensearch-keystore" add "opensearch.notifications.core.email.$SENDER_NAME.username" --stdin
    fi

    if ! "$PACKAGE_DIR/bin/opensearch-keystore" get "opensearch.notifications.core.email.$SENDER_NAME.password"; then
      echo "adding password for $SENDER_NAME to keystore"
      echo "$PASSWORD" | "$PACKAGE_DIR/bin/opensearch-keystore" add "opensearch.notifications.core.email.$SENDER_NAME.password" --stdin
    fi
  done

  # Copy updated keystore to persistent volume
  cp "$OPENSEARCH_PATH_CONF/opensearch.keystore" "$STORE_DIR/opensearch.keystore"

  CA="--cacert ${JOB_DIR}/config/ssl/opensearch.ca"
  CERT="--cert ${JOB_DIR}/config/ssl/opensearch-admin.crt"
  KEY="--key ${JOB_DIR}/config/ssl/opensearch-admin.key"

  # Reload nodes to recognize new keystore values
  curl -X POST \
    ${CA} ${CERT} ${KEY} \
    -s https://localhost:9200/_nodes/reload_secure_settings

<% end %>

exit 0
