#!/bin/bash

set -e
set -x

<% if p('opensearch.cloud.aws.bucket') != '' and p('opensearch.node.allow_cluster_manager') and spec.bootstrap %>
curl -X PUT \
  --key ssl/opensearch-admin.key \
  --cert ssl/opensearch-admin.crt  \
  --cacert ssl/opensearch.ca \
  -s https://localhost:9200/_snapshot/<%= p('opensearch.snapshots.repository') %> \
  -H 'Content-Type: application/json' \
  -d '{"type": "s3", "settings": {"bucket": "<%= p('opensearch.cloud.aws.bucket') %>"}}'
<% end %>

<% if p('opensearch.path_repo') != '' and p('opensearch.node.allow_cluster_manager') and spec.bootstrap %>
curl -X PUT \
  --key ssl/opensearch-admin.key \
  --cert ssl/opensearch-admin.crt  \
  --cacert ssl/opensearch.ca \
  -s https://localhost:9200/_snapshot/<%= p('opensearch.snapshots.repository') %> \
  -H 'Content-Type: application/json' \
  -d '{"type": "fs", "settings": {"location": "<%= p('opensearch.path_repo') %>/<%= p('opensearch.snapshots.repository') %>", "compress": true}}'
<% end %>
