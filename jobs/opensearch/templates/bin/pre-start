#!/usr/bin/env bash
sysctl -q -w vm.max_map_count=262144
mkdir -p /var/vcap/packages/opensearch/plugins
if [ -d /var/vcap/jobs/opensearch/config/ssl ]; then
	chown vcap  /var/vcap/jobs/opensearch/config/ssl
fi

# install plugins
rm -rf /var/vcap/packages/opensearch/plugins/*
<% if_p('opensearch.cloud.aws.access_key', 'opensearch.cloud.aws.secret_key') do %>
  /var/vcap/packages/opensearch/bin/opensearch-plugin install -b repository-s3
<% end %>
<% p("opensearch.plugins").each do |plugin| name, path = plugin.first %>
  <% if path.start_with? '/var/vcap' %>
    /var/vcap/packages/opensearch/bin/opensearch-plugin install -b "file://<%= path %>"
  <% elsif path.start_with? 'http' %>
    /var/vcap/packages/opensearch/bin/opensearch-plugin install -b "<%= path %>"
  <% else %>
    /var/vcap/packages/opensearch/bin/opensearch-plugin install -b "<%= path %>"
  <% end %>
<% end %>

#cp -p /var/vcap/packages/opensearch/config/jvm.options /var/vcap/jobs/opensearch/config/jvm.options
#chown root:vcap /var/vcap/jobs/opensearch/config/jvm.options

#log_dir=/var/vcap/packages/opensearch/logs

# if [[ -d ${log_dir} ]]; then
#   rmdir ${log_dir}
# fi

# if [[ ! -a ${log_dir} ]]; then
#   ln -s /var/vcap/sys/log/opensearch ${log_dir}
# fi