#!/usr/bin/env bash

set -eu

export JQ_PACKAGE_DIR=/var/vcap/packages/jq
export PATH=$JQ_PACKAGE_DIR/bin:$PATH

export JOB_NAME=opensearch
export JOB_DIR=/var/vcap/jobs/$JOB_NAME
export STORE_DIR=/var/vcap/store/$JOB_NAME
export PATH_CONF=${JOB_DIR}/config
export PACKAGE_DIR=/var/vcap/packages/$JOB_NAME

source "$JOB_DIR/config/.env"

<% if_p('opensearch.notifications.credential_map') do %>
  for SENDER_NAME in $(echo "$CREDENTIAL_MAP" | jq -r '. | keys | join("\n")'); do
    SENDER_DATA=$(echo "$CREDENTIAL_MAP" | jq --arg sender "$SENDER_NAME" '.[$sender]')
    USERNAME=$(echo "$SENDER_DATA" | jq -r '.username')
    PASSWORD=$(echo "$SENDER_DATA" | jq -r '.password')

    USERNAME_CREDENTIAL_NAME="opensearch.notifications.core.email.$SENDER_NAME.username"
    PASSWORD_CREDENTIAL_NAME="opensearch.notifications.core.email.$SENDER_NAME.password"

    if "$PACKAGE_DIR/bin/opensearch-keystore" list | grep -q "$USERNAME_CREDENTIAL_NAME"; then
      echo "removing username for $SENDER_NAME in keystore"
      echo "$USERNAME" | "$PACKAGE_DIR/bin/opensearch-keystore" remove "$USERNAME_CREDENTIAL_NAME"
    fi

    echo "adding username for $SENDER_NAME to keystore"
    echo "$USERNAME" | "$PACKAGE_DIR/bin/opensearch-keystore" add "$USERNAME_CREDENTIAL_NAME" --stdin

    if "$PACKAGE_DIR/bin/opensearch-keystore" list | grep -q "$PASSWORD_CREDENTIAL_NAME"; then
      echo "removing password for $SENDER_NAME in keystore"
      echo "$PASSWORD" | "$PACKAGE_DIR/bin/opensearch-keystore" remove "$PASSWORD_CREDENTIAL_NAME"
    fi

    echo "adding password for $SENDER_NAME to keystore"
    echo "$PASSWORD" | "$PACKAGE_DIR/bin/opensearch-keystore" add "$PASSWORD_CREDENTIAL_NAME" --stdin
  done

  # Errand runs as root, so make sure file goes back to vcap ownership
  # otherwise curl below will failed to reload settings from this node
  chown vcap:vcap "$PATH_CONF/opensearch.keystore"

  CA="--cacert ${JOB_DIR}/config/ssl/opensearch.ca"
  CERT="--cert ${JOB_DIR}/config/ssl/opensearch-admin.crt"
  KEY="--key ${JOB_DIR}/config/ssl/opensearch-admin.key"

  # Reload nodes to recognize new keystore values
  curl -X POST \
    ${CA} ${CERT} ${KEY} \
    -s https://localhost:9200/_nodes/reload_secure_settings

<% end %>

exit 0
