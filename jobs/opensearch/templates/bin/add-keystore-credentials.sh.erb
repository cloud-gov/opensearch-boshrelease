#!/usr/bin/env bash

set -Eeuo pipefail

export JQ_PACKAGE_DIR=/var/vcap/packages/jq
export PATH=$JQ_PACKAGE_DIR/bin:$PATH

export JOB_NAME=opensearch
export JOB_DIR=/var/vcap/jobs/$JOB_NAME
export STORE_DIR=/var/vcap/store/$JOB_NAME
export PATH_CONF=${JOB_DIR}/config
export PACKAGE_DIR=/var/vcap/packages/$JOB_NAME

<% if_p('opensearch.notifications.secrets_prefix') do |prefix| %>
  for SECRET_NAME in $(aws secretsmanager list-secrets --filters Key=name,Values=<%= prefix %> | jq -r '.SecretList[].Name'); do
    SECRET_DATA=$(aws secretsmanager get-secret-value --secret-id "$SECRET_NAME" | jq -r '.SecretString')
    SENDER_NAME=$(echo "$SECRET_DATA" | jq -r '.email_sender_name')
    USERNAME=$(echo "$SECRET_DATA" | jq -r '.username')
    PASSWORD=$(echo "$SECRET_DATA" | jq -r '.password')

    echo "adding username for $SENDER_NAME to keystore"
    echo "$USERNAME" | "$PACKAGE_DIR/bin/opensearch-keystore" add "opensearch.notifications.core.email.$SENDER_NAME.username" --stdin -f

    echo "adding password for $SENDER_NAME to keystore"
    echo "$PASSWORD" | "$PACKAGE_DIR/bin/opensearch-keystore" add "opensearch.notifications.core.email.$SENDER_NAME.password" --stdin -f
  done

  # Errand runs as root, so make sure file goes back to vcap ownership
  # otherwise curl below will failed to reload settings from this node
  chown vcap:vcap "$PATH_CONF/opensearch.keystore"

  CA="--cacert ${JOB_DIR}/config/ssl/opensearch.ca"
  CERT="--cert ${JOB_DIR}/config/ssl/opensearch-admin.crt"
  KEY="--key ${JOB_DIR}/config/ssl/opensearch-admin.key"

  # Reload nodes to recognize new keystore values
  curl -X POST \
    ${CA} ${CERT} ${KEY} \
    -s https://localhost:9200/_nodes/reload_secure_settings
<% end %>

exit 0
