name: opensearch
instance_groups:
- name: opensearch_manager
  azs:
  - z1
  instances: 1
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    consumes:
      opensearch:
        from: opensearch_manager
    provides:
      opensearch:
        as: opensearch_manager
    properties:
      opensearch:
        clustername: opensearch
        limits:
          fd: 131072
        node:
          allow_cluster_manager: true
          allow_data: false
        http_host: 127.0.0.1
        jvm_options:
          - "-Dlog4j2.formatMsgNoLookups=true"
        username: ((opensearch_username))
        password: ((opensearch_password))
    release: opensearch
  persistent_disk: 10240
  stemcell: default
  vm_type: t3.large
  networks:
   - name: services
- name: opensearch_dashboards
  azs:
  - z1
  instances: 1
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    release: opensearch
    consumes:
      opensearch:
        from: opensearch_manager
    properties:
      opensearch:
        username: ((opensearch_username))
        password: ((opensearch_password))
  - name: opensearch_dashboards
    consumes:
      opensearch:
        from: opensearch_manager
    properties:
      opensearch_dashboards:
        config_options:
          server.maxPayloadBytes: 4194304
        console.enabled: false
        defaultappid: dashboard/App-Overview
        env:
        - NODE_ENV: production
        health:
          timeout: 600
        memory_limit: 75
        username: ((opensearch_username))
        password: ((opensearch_password))
    provides:
      opensearch-dashboard:
        as: opensearch_link
    release: opensearch
  persistent_disk: 10240
  stemcell: default
  vm_type: t3.large
  networks:
   - name: services
- name: opensearch_data
  instances: 3
  jobs:
  - name: bpm
    release: bpm
  - name: opensearch
    release: opensearch
    consumes:
      opensearch:
        from: opensearch_manager
    properties:
      opensearch:
        node:
          allow_cluster_manager: false
          allow_data: true
        limits:
          fd: 131072  # 2 ** 17
        health:
          timeout: 900
          disable_post_start: true
        recovery:
          delay_allocation_restart: "15m"
        config_options:
          indices.query.bool.max_clause_count: 2048
        jvm_options:
          - "-Dlog4j2.formatMsgNoLookups=true"
        username: ((opensearch_username))
        password: ((opensearch_password))
  persistent_disk: 10240
  stemcell: default
  azs: [z1]
  vm_type: t3.large
  networks:
  - name: services
  update:
    max_in_flight: 1 # Only update 1 data node at a time or risk downtime
  env:
    bosh:
      swap_size: 0
releases:
- name: opensearch
  version: latest
- name: bpm
  version: latest
stemcells:
- alias: default
  os: ubuntu-jammy
  version: "1.181"
update:
  canaries: 1
  canary_watch_time: 30000-600000
  max_errors: 1
  max_in_flight: 1
  serial: false
  update_watch_time: 5000-600000
variables:
  - name: opensearch_username
    type: password
  - name: opensearch_password
    type: password
